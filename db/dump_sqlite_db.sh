#!/bin/sh

# http://stackoverflow.com/questions/75675/how-do-i-dump-the-data-of-some-sqlite3-tables/37296788
# http://stackoverflow.com/questions/4199850/sqlite-export-with-column-names

# comunidades

TABLES='puntos_viviendas entrevistadores entrevistados subcuencas adescos cargos_publicos ongs otras_organizaciones tipos_cultivos produccion_consumo areas_potenciales_riego ganaderia cooperativas centros_educativos centros_salud otros_servicios capacitaciones_riesgos amenazas implicacion_comunidad abastecimientos r_abastecimientos_comunidades valoracion_sistema datos_consumo habitos_consumo fuentes_contaminacion juntas_agua personal_tecnico bombeos cobertura captaciones dep_intermedios dep_distribucion tuberias gest_comercial gest_financiera evaluacion fuentes r_abastecimientos_fuentes aforos niveles_freaticos analiticas comunidades_croquis alternativas preferencias_disenho comunidades_implicadas fuentes_implicadas alt_embalses alt_fuentes alt_depositos alt_tuberias alt_bombeos alt_conexiones alt_valvulas presupuesto'

echo 'BEGIN TRANSACTION;' > /tmp/backup.sql
echo '' >> /tmp/backup.sql

echo -e ".mode insert comunidades\nselect comunidad,cod_comunidad,fecha,coment_gen,departamento,cod_departamento,municipio,cod_municipio,canton,cod_canton,caserio,cod_caserio,utm_x,utm_y,utm_z,punto_descripcion,cuenca,coment_loc,tip_nucleo,anho_establecimiento,n_familias,n_viviendas,n_habitantes,tip_origen,antiguedad,lug_origen,n_ninhas,n_ninhos,tot_ninhos,n_muj_jovenes,n_hom_jovenes,n_mujeres,n_hombres,tot_adultos,n_ancianas,n_ancianos,tot_ancianos,resum_censo,coment_pob,h_adescos,n_adescos,h_cargos_publicos,exp_ongs,coment_org,emigracion,f_primario,f_secundario,f_terciario,resum_econ,cp_granos,sub_granos,cp_ganaderia,sub_ganaderia,cp_frutales,sub_frutales,cp_otros,sub_otros,f_c_propia,ca_cafe,ca_canha,ca_frutales,ca_otros,f_c_ajena,ind_tall_maq,f_industria,f_indus_for,f_indus_inf,f_construccion,f_const_for,f_const_inf,f_maquila,f_otros_sec,comer_serv,f_comercio,f_comer_for,f_comer_inf,f_otros_ter,n_agropecuario,n_industria,n_construccion,n_maquila,n_comercio,n_otros,coment_eco,f_propietarias,prop_hombres,prop_mujeres,prop_registrada,prop_tramites,prop_noregistrada,prop_area_cultivada,f_arrendatarias,arre_hombres,arre_mujeres,arre_area_cultivada,f_medias,med_hombres,med_mujeres,med_area_cultivada,area_cultivada,tip_cultivos,produccion,consumo,lug_agua_cercano,tip_regadio,sup_total_riego,areas_pot_riego,agroquimicos,tip_agroquimicos,tec_conservacion,tip_tec_conservacion,form_agricola,f_form_agricola,form_ambiental,f_form_ambiental,n_vacas,n_gallinas,n_cerdos,n_burros,n_caballos,h_cooperativas,f_viv_prop,viv_prop_hombres,viv_prop_mujeres,f_viv_noprop,viv_bahareque,viv_adobe,viv_mixto,viv_otros,coc_lenha,coc_lenha_mej,electricidad,viv_electricidad,tarifa_electricidad,alumbrado,telf_fijo,telf_movil,cent_educativos,n_cent_educativos,h_prog_salud,prog_salud,frec_prog_salud,as_unidad_salud,as_clinica_comunal,as_promotor,as_otros,as_otros_detalle,n_cent_salud,t_unidad_salud,t_clinica_comunal,frec_med_clinica,frec_promotor,enf_tip_ninhos,muertes_ninhos,muertes_ninhos_enf_agua,enf_tip_adultos,muertes_adultos,f_dat_sanidad,n_iglesias,tip_acceso,tip_sup_acceso,acceso_ver,acceso_inv,trans_publico,frec_tpublico,t_parada,t_cabmunicipal,otros_transportes,coment_ser,llano,pend_media,pend_elevada,veg_residencial,veg_industrial,veg_agricola,veg_forestal,veg_for_sup,deforestacion,avance_fagricola,riesgo_erosion,frec_incendios,est_hidrogeologicos,autor_hidrogeo,pozos_extraccion,pozos_nivel,conserv_ma,desc_conserv_ma,fr_deslizam,fr_desbord,fr_inundac,fr_asaltos,fr_ninguno,fr_otros,fr_otros_detalle,ult_fenomeno,f_dat_frg,comite_riesgos,comite_activo,comite,capac_riesgos,coment_frg,sist_abastecimiento,n_viv_abast,origen_aguas,f_dat_abast,resum_abast,aba_s_cantareras,aba_ll_cantareras,aba_s_domiciliar,aba_ll_domiciliar,tot_s_abast,tot_ll_abast,aba_s_nacimiento,aba_ll_nacimiento,aba_s_rio,aba_ll_rio,aba_s_quebrada,aba_ll_quebrada,aba_s_lluvia,aba_ll_lluvia,aba_s_broquel,aba_ll_broquel,aba_s_broquel_com,aba_ll_broquel_com,aba_s_compra,aba_ll_compra,aba_s_vecino,aba_ll_vecino,tot_s_sin_abast,tot_ll_sin_abast,cons_dom,cons_ag_gan,tot_consumo,comen_cons,cons_hab,f_rio,f_manantial,f_pozo,f_quebrada,f_compra,coste_agua,t_medio_fuente,seca_suficiencia,seca_t_espera,lluvia_suficiencia,lluvia_t_espera,res_hab_agua,coment_agua,coment_hab,sist_alcantarillado,alc_completo,evac_calle,evac_familiar,evac_comunal,evac_otros,ag_gris_calle,a_gris_quebrada,trat_ag_residuales,trat_trampa,trat_biofiltro,trat_otros,sin_tratamiento,trat_comunal,let_vivienda,let_comunal,let_monte,let_hoyo,let_septica,let_hidra,h_let_abonera,let_abonera,pq_no_aboneras,trat_aboneras,disp_abono,uso_letrinas,dist_let_agua,h_lavad_comun,n_lavaderos,tip_almacenamiento,n_pilas,n_barriles,disp_basuras,coment_san,necesidad1,necesidad2,necesidad3,necesidad4,geom,veg_coniferas,veg_latifoliado,veg_mixto,veg_mangle,veg_matorral,veg_pasto,veg_otros from comunidades;\n" | sqlite3 $1 | sed "s/^INSERT INTO comunidades/INSERT INTO comunidades (comunidad,cod_comunidad,fecha,coment_gen,departamento,cod_departamento,municipio,cod_municipio,canton,cod_canton,caserio,cod_caserio,utm_x,utm_y,utm_z,punto_descripcion,cuenca,coment_loc,tip_nucleo,anho_establecimiento,n_familias,n_viviendas,n_habitantes,tip_origen,antiguedad,lug_origen,n_ninhas,n_ninhos,tot_ninhos,n_muj_jovenes,n_hom_jovenes,n_mujeres,n_hombres,tot_adultos,n_ancianas,n_ancianos,tot_ancianos,resum_censo,coment_pob,h_adescos,n_adescos,h_cargos_publicos,exp_ongs,coment_org,emigracion,f_primario,f_secundario,f_terciario,resum_econ,cp_granos,sub_granos,cp_ganaderia,sub_ganaderia,cp_frutales,sub_frutales,cp_otros,sub_otros,f_c_propia,ca_cafe,ca_canha,ca_frutales,ca_otros,f_c_ajena,ind_tall_maq,f_industria,f_indus_for,f_indus_inf,f_construccion,f_const_for,f_const_inf,f_maquila,f_otros_sec,comer_serv,f_comercio,f_comer_for,f_comer_inf,f_otros_ter,n_agropecuario,n_industria,n_construccion,n_maquila,n_comercio,n_otros,coment_eco,f_propietarias,prop_hombres,prop_mujeres,prop_registrada,prop_tramites,prop_noregistrada,prop_area_cultivada,f_arrendatarias,arre_hombres,arre_mujeres,arre_area_cultivada,f_medias,med_hombres,med_mujeres,med_area_cultivada,area_cultivada,tip_cultivos,produccion,consumo,lug_agua_cercano,tip_regadio,sup_total_riego,areas_pot_riego,agroquimicos,tip_agroquimicos,tec_conservacion,tip_tec_conservacion,form_agricola,f_form_agricola,form_ambiental,f_form_ambiental,n_vacas,n_gallinas,n_cerdos,n_burros,n_caballos,h_cooperativas,f_viv_prop,viv_prop_hombres,viv_prop_mujeres,f_viv_noprop,viv_bahareque,viv_adobe,viv_mixto,viv_otros,coc_lenha,coc_lenha_mej,electricidad,viv_electricidad,tarifa_electricidad,alumbrado,telf_fijo,telf_movil,cent_educativos,n_cent_educativos,h_prog_salud,prog_salud,frec_prog_salud,as_unidad_salud,as_clinica_comunal,as_promotor,as_otros,as_otros_detalle,n_cent_salud,t_unidad_salud,t_clinica_comunal,frec_med_clinica,frec_promotor,enf_tip_ninhos,muertes_ninhos,muertes_ninhos_enf_agua,enf_tip_adultos,muertes_adultos,f_dat_sanidad,n_iglesias,tip_acceso,tip_sup_acceso,acceso_ver,acceso_inv,trans_publico,frec_tpublico,t_parada,t_cabmunicipal,otros_transportes,coment_ser,llano,pend_media,pend_elevada,veg_residencial,veg_industrial,veg_agricola,veg_forestal,veg_for_sup,deforestacion,avance_fagricola,riesgo_erosion,frec_incendios,est_hidrogeologicos,autor_hidrogeo,pozos_extraccion,pozos_nivel,conserv_ma,desc_conserv_ma,fr_deslizam,fr_desbord,fr_inundac,fr_asaltos,fr_ninguno,fr_otros,fr_otros_detalle,ult_fenomeno,f_dat_frg,comite_riesgos,comite_activo,comite,capac_riesgos,coment_frg,sist_abastecimiento,n_viv_abast,origen_aguas,f_dat_abast,resum_abast,aba_s_cantareras,aba_ll_cantareras,aba_s_domiciliar,aba_ll_domiciliar,tot_s_abast,tot_ll_abast,aba_s_nacimiento,aba_ll_nacimiento,aba_s_rio,aba_ll_rio,aba_s_quebrada,aba_ll_quebrada,aba_s_lluvia,aba_ll_lluvia,aba_s_broquel,aba_ll_broquel,aba_s_broquel_com,aba_ll_broquel_com,aba_s_compra,aba_ll_compra,aba_s_vecino,aba_ll_vecino,tot_s_sin_abast,tot_ll_sin_abast,cons_dom,cons_ag_gan,tot_consumo,comen_cons,cons_hab,f_rio,f_manantial,f_pozo,f_quebrada,f_compra,coste_agua,t_medio_fuente,seca_suficiencia,seca_t_espera,lluvia_suficiencia,lluvia_t_espera,res_hab_agua,coment_agua,coment_hab,sist_alcantarillado,alc_completo,evac_calle,evac_familiar,evac_comunal,evac_otros,ag_gris_calle,a_gris_quebrada,trat_ag_residuales,trat_trampa,trat_biofiltro,trat_otros,sin_tratamiento,trat_comunal,let_vivienda,let_comunal,let_monte,let_hoyo,let_septica,let_hidra,h_let_abonera,let_abonera,pq_no_aboneras,trat_aboneras,disp_abono,uso_letrinas,dist_let_agua,h_lavad_comun,n_lavaderos,tip_almacenamiento,n_pilas,n_barriles,disp_basuras,coment_san,necesidad1,necesidad2,necesidad3,necesidad4,geom,veg_coniferas,veg_latifoliado,veg_mixto,veg_mangle,veg_matorral,veg_pasto,veg_otros)/" >> /tmp/backup.sql


for t in $TABLES ; do
    COLS=`sqlite3 $1 "pragma table_info(${t})" | grep -v '|gid|' | cut -d'|' -f2`
    SELECT_COLS=`echo $COLS | sed -e 's/ /,/g'`
    INSERT_COLS=$SELECT_COLS

    if [[ ${t} == 'preferencias_disenho' ]] ; then
	# No hay forma, racional, de desactivar triggers en sqlite y insertar en alternativas crea automaticamente entradas en preferencias
	# por lo que habrÃ­a que hacer updates en lugar de inserts.
	echo 'DELETE FROM preferencias_disenho;' >> /tmp/backup.sql
    fi
    if [[ ${t} == 'presupuesto' ]] ; then
	echo 'DELETE FROM presupuesto;' >> /tmp/backup.sql
    fi

    if [[ ${t} == 'fuentes_implicadas' ]] ; then
	continue
    fi

    echo -e ".mode insert ${t}\nselect ${SELECT_COLS} from ${t};\n" | sqlite3 $1 | sed "s/^INSERT INTO ${t}/INSERT INTO ${t} (${INSERT_COLS})/" >> /tmp/backup.sql
done

echo '' >> /tmp/backup.sql
echo 'COMMIT;' >> /tmp/backup.sql


# spatialite -bail fonsagua.sqlite < /tmp/backup.sql
